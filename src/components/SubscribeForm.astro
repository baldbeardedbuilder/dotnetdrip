---
interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
const convertKitFormId = import.meta.env.PUBLIC_CONVERTKIT_FORM_ID || "";
---

<div class:list={["w-full max-w-md", className]}>
  <!-- Form State (visible by default) -->
  <div id="subscribe-form-container">
    <h2 class="text-xl font-semibold text-center mb-4 bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent">
      Subscribe to the Newsletter
    </h2>
    
    <form class="space-y-4" action="/?subscribed=true" method="POST" id="subscribe-form" name="net-drip" data-netlify="true" netlify-honeypot="bot-field">
      <p class="hidden">
        <label>Don't fill this out if you're human: <input name="bot-field" /></label>
      </p>
      <div>
        <label for="email" class="block text-base font-medium text-text-primary text-left mb-2">
          Email Address
        </label>
        <input
          type="email"
          id="email"
          name="email"
          placeholder="you@example.com"
          required
          class="w-full px-4 py-3 rounded-lg border border-border bg-surface text-base text-text-primary placeholder-text-secondary/50 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200"
        />
        <p id="email-error" class="mt-2 text-sm text-red-500 hidden"></p>
      </div>
      
      <button
        type="submit"
        id="subscribe-button"
        class="w-full px-6 py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-all duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Subscribe to .NET drip
      </button>
    </form>
    
    <p class="text-xs text-text-secondary text-center mt-4">
      No spam, unsubscribe at any time. We respect your privacy.
    </p>
  </div>

  <!-- Success State (hidden by default) -->
  <div id="subscribe-success" class="hidden">
    <h2 class="text-xl font-semibold text-center mb-6 bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent">
      Thank You for Subscribing!
    </h2>
    
    <div class="relative">
      <div class="absolute inset-0 bg-gradient-to-r from-indigo-500/20 via-purple-500/20 to-indigo-500/20 dark:from-indigo-500/30 dark:via-purple-500/30 dark:to-indigo-500/30 rounded-2xl blur-xl"></div>
      <div class="relative bg-white/80 dark:bg-surface/50 backdrop-blur-sm border border-border rounded-2xl p-8 shadow-2xl">
        <div class="flex flex-col items-center text-center space-y-4">
          <div class="relative">
            <div class="absolute inset-0 bg-green-500/20 dark:bg-green-400/30 blur-2xl rounded-full"></div>
            <svg class="relative w-16 h-16 text-green-600 dark:text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="m9 12 2 2 4-4"></path>
            </svg>
          </div>
          
          <div class="space-y-2">
            <h3 class="text-2xl font-semibold text-text-primary">You're all set!</h3>
            <p class="text-text-secondary">
              We've added you to the .NET drip newsletter.
            </p>
          </div>

          <div class="flex items-center gap-2 text-sm text-text-secondary pt-4">
            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="20" height="16" x="2" y="4" rx="2"></rect>
              <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
            </svg>
            <span>Newsletters drop every Monday, Wednesday, and Friday.</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  // Check for success query param on page load
  (function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('subscribed') === 'true') {
      const formContainer = document.getElementById('subscribe-form-container');
      const successContainer = document.getElementById('subscribe-success');
      if (formContainer && successContainer) {
        formContainer.classList.add('hidden');
        successContainer.classList.remove('hidden');
      }
    }
  })();

  const subscribeForm = document.getElementById("subscribe-form");
  const subscribeEmailInput = document.getElementById("email");
  const subscribeEmailError = document.getElementById("email-error");
  
  function showSubscribeError(message) {
    if (subscribeEmailError) {
      subscribeEmailError.textContent = message;
      subscribeEmailError.classList.remove("hidden");
    }
  }
  
  function clearSubscribeError() {
    if (subscribeEmailError) {
      subscribeEmailError.textContent = "";
      subscribeEmailError.classList.add("hidden");
    }
  }
  
  function validateSubscribeEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }
  
  subscribeEmailInput?.addEventListener("input", () => {
    clearSubscribeError();
  });
  
  subscribeForm?.addEventListener("submit", (e) => {
    clearSubscribeError();
    
    const email = subscribeEmailInput?.value?.trim();
    
    // Validate email
    if (!email) {
      e.preventDefault();
      showSubscribeError("Email is required");
      return;
    }
    
    if (!validateSubscribeEmail(email)) {
      e.preventDefault();
      showSubscribeError("Please enter a valid email address");
      return;
    }
    
    // Validation passed - allow form to submit naturally
  });
</script>
